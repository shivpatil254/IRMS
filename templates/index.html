<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Requirements Management System (IRMS)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #667eea;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .requirements-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .requirement-item {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .requirement-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .requirement-item.selected {
            border-color: #667eea;
            background: #f3f4ff;
        }
        
        .req-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .req-id {
            font-weight: bold;
            color: #667eea;
        }
        
        .req-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-ready-for-review {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-ready-for-testing {
            background: #f3e8ff;
            color: #6b21a8;
        }
        
        .status-testing {
            background: #fce7f3;
            color: #be185d;
        }
        
        .status-failed-testing {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-deployed {
            background: #cffafe;
            color: #0e7490;
        }
        
        .status-on-hold {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .status-cancelled {
            background: #fecaca;
            color: #991b1b;
        }
        
        .status-closed {
            background: #e5e7eb;
            color: #374151;
        }
        
        .user-story {
            margin: 10px 0;
            font-style: italic;
            color: #4a5568;
        }
        
        .acceptance-criteria {
            margin-top: 10px;
        }
        
        .criteria-list {
            list-style: none;
            padding-left: 20px;
        }
        
        .criteria-list li {
            margin: 5px 0;
            position: relative;
        }
        
        .criteria-list li:before {
            content: "‚úì";
            position: absolute;
            left: -20px;
            color: #10b981;
            font-weight: bold;
        }
        
        .stakeholders {
            margin-top: 20px;
        }
        
        .stakeholder-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .sample-text {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .communication-template {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        select {
            padding: 8px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .action-buttons button {
            margin-top: 0;
            padding: 8px 20px;
            font-size: 14px;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* BRD Specific Styles */
        .brd-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .image-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .image-upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .uploaded-image {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .uploaded-image img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        .mermaid-container {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }
        
        .diagram-editor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .diagram-code {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            min-height: 300px;
        }
        
        .brd-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.6;
        }
        
        .brd-preview h1, .brd-preview h2, .brd-preview h3 {
            color: #1a202c;
            margin: 20px 0 10px 0;
        }
        
        .brd-preview h1 {
            font-size: 24px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .brd-preview h2 {
            font-size: 20px;
            color: #2d3748;
        }
        
        .brd-preview h3 {
            font-size: 16px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <header>
        <h1>üéØ Intelligent Requirements Management System</h1>
        <p class="subtitle">Transform meeting notes into actionable user stories and professional BRDs with AI</p>
    </header>
    
    <div class="container">
        <div class="main-content">
            <!-- Input Section -->
            <div class="card">
                <h2>üìù Meeting Transcript Input</h2>
                <textarea id="transcriptInput" placeholder="Paste your meeting transcript or requirements discussion here...

Example: In today's meeting, we discussed that users need to be able to create and manage their profiles. The system should allow customers to update their personal information easily. We also want to implement a search feature so that managers can find specific user accounts quickly."></textarea>
                
                <div class="sample-text">
                    <strong>Tip:</strong> Include phrases like "we need to", "the system should", "users must be able to" for better extraction.
                </div>
                
                <button onclick="analyzeTranscript()" id="analyzeBtn">
                    üöÄ Analyze & Extract Requirements
                </button>
                
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Analyzing transcript...</p>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="card">
                <h2>üìã Extracted Requirements</h2>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('requirements')">Requirements</div>
                    <div class="tab" onclick="switchTab('stakeholders')">Stakeholders</div>
                    <div class="tab" onclick="switchTab('communication')">Communication</div>
                    <div class="tab" onclick="switchTab('brd')">BRD Generator</div>
                    <div class="tab" onclick="switchTab('diagrams')">Diagrams</div>
                </div>
                
                <div class="tab-content active" id="requirements-tab">
                    <div class="checkbox-container">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">Select All Requirements for BRD</label>
                    </div>
                    <div class="requirements-list" id="requirementsList">
                        <p style="color: #9ca3af; text-align: center; padding: 40px;">
                            No requirements extracted yet. Paste a meeting transcript and click analyze.
                        </p>
                    </div>
                </div>
                
                <div class="tab-content" id="stakeholders-tab">
                    <div id="stakeholdersList">
                        <p style="color: #9ca3af; text-align: center; padding: 40px;">
                            No stakeholders identified yet.
                        </p>
                    </div>
                </div>
                
                <div class="tab-content" id="communication-tab">
                    <div>
                        <select id="requirementSelect">
                            <option value="">Select a requirement</option>
                        </select>
                        <select id="stakeholderType">
                            <option value="general">General</option>
                            <option value="executive">Executive</option>
                            <option value="technical">Technical Team</option>
                        </select>
                        <button onclick="generateCommunication()">Generate Template</button>
                    </div>
                    <div id="communicationTemplate" style="margin-top: 20px;"></div>
                </div>
                
                <div class="tab-content" id="brd-tab">
                    <div class="brd-form">
                        <h3>BRD Information</h3>
                        <div class="form-group">
                            <label>Project Name:</label>
                            <input type="text" id="projectName" placeholder="Enter project name">
                        </div>
                        <div class="form-group">
                            <label>Author:</label>
                            <input type="text" id="authorName" placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label>Executive Summary:</label>
                            <textarea id="executiveSummary" rows="3" placeholder="Brief overview of the project"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Business Objectives:</label>
                            <textarea id="businessObjectives" rows="3" placeholder="Key business goals"></textarea>
                        </div>
                        
                        <div class="image-upload-area" onclick="document.getElementById('imageUpload').click()">
                            <p>üì∑ Click to upload brainstorming images/diagrams</p>
                            <p style="font-size: 12px; color: #6b7280;">PNG, JPG, up to 5MB</p>
                            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                        </div>
                        
                        <div class="uploaded-images" id="uploadedImages"></div>
                        
                        <button onclick="generateBRD()" class="btn-success">
                            üìÑ Generate BRD Document
                        </button>
                    </div>
                    
                    <div id="brdPreview" style="margin-top: 20px;"></div>
                </div>
                
                <div class="tab-content" id="diagrams-tab">
                    <h3>Create Diagrams for BRD</h3>
                    <p style="margin-bottom: 15px;">Use Mermaid syntax to create flowcharts, sequence diagrams, and more.</p>
                    
                    <select id="diagramType" onchange="insertDiagramTemplate()">
                        <option value="">Select diagram type</option>
                        <option value="flowchart">Flowchart</option>
                        <option value="sequence">Sequence Diagram</option>
                        <option value="entityRelationship">Entity Relationship</option>
                        <option value="userJourney">User Journey</option>
                    </select>
                    
                    <div class="diagram-editor">
                        <div>
                            <h4>Diagram Code:</h4>
                            <textarea id="diagramCode" class="diagram-code" placeholder="Enter Mermaid diagram code here...">graph TD
    A[User Login] --> B{Authentication}
    B -->|Success| C[Dashboard]
    B -->|Failure| D[Error Message]
    D --> A</textarea>
                            <button onclick="renderDiagram()">Preview Diagram</button>
                        </div>
                        <div>
                            <h4>Preview:</h4>
                            <div id="diagramPreview" class="mermaid-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard -->
            <div class="card full-width">
                <h2>üìä Requirements Dashboard</h2>
                <div id="dashboard">
                    <p style="color: #9ca3af; text-align: center; padding: 40px;">
                        Dashboard will populate after analyzing requirements.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: true });
        
        let currentRequirements = [];
        let currentStakeholders = [];
        let uploadedImages = [];
        let currentDiagrams = [];
        
        async function analyzeTranscript() {
            console.log('analyzeTranscript called');
            const transcript = document.getElementById('transcriptInput').value;
            if (!transcript.trim()) {
                alert('Please enter a meeting transcript to analyze.');
                return;
            }
            
            // Show loading
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                console.log('Sending request to server...');
                const response = await fetch('/analyze_transcript', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ transcript: transcript })
                });
                
                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    currentRequirements = data.requirements;
                    currentStakeholders = data.stakeholders;
                    displayRequirements(data.requirements);
                    displayStakeholders(data.stakeholders);
                    updateDashboard();
                    populateRequirementSelect();
                } else {
                    alert('Error: ' + (data.error || 'Failed to analyze transcript'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        function displayRequirements(requirements) {
            const container = document.getElementById('requirementsList');
            
            if (requirements.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">No requirements found. Try adding more specific requirement phrases.</p>';
                return;
            }
            
            container.innerHTML = requirements.map(req => `
                <div class="requirement-item" data-req-id="${req.id}">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="req-checkbox" value="${req.id}" onchange="updateBRDSelection()">
                        <div style="flex: 1;">
                            <div class="req-header">
                                <span class="req-id">${req.id}</span>
                                <span class="req-status status-${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span>
                            </div>
                            <div class="user-story">"${req.user_story}"</div>
                            <div class="acceptance-criteria">
                                <strong>Acceptance Criteria:</strong>
                                <ul class="criteria-list">
                                    ${req.acceptance_criteria.map(criteria => `<li>${criteria}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-secondary" onclick="editRequirement('${req.id}')">Edit</button>
                                <button onclick="updateStatus('${req.id}')">Update Status</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayStakeholders(stakeholders) {
            const container = document.getElementById('stakeholdersList');
            
            if (stakeholders.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">No stakeholders identified.</p>';
                return;
            }
            
            container.innerHTML = '<div class="stakeholders">' +
                stakeholders.map(stakeholder => `<span class="stakeholder-tag">${stakeholder}</span>`).join('') +
                '</div>';
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        function updateDashboard() {
            const container = document.getElementById('dashboard');
            const total = currentRequirements.length;
            const byStatus = currentRequirements.reduce((acc, req) => {
                acc[req.status] = (acc[req.status] || 0) + 1;
                return acc;
            }, {});
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: #f3f4f6; border-radius: 8px;">
                        <h3 style="color: #667eea; font-size: 2em; margin: 0;">${total}</h3>
                        <p style="margin: 5px 0;">Total Requirements</p>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px;">
                        <h3 style="color: #92400e; font-size: 2em; margin: 0;">${byStatus['Draft'] || 0}</h3>
                        <p style="margin: 5px 0;">Draft</p>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #e0e7ff; border-radius: 8px;">
                        <h3 style="color: #3730a3; font-size: 2em; margin: 0;">${byStatus['Ready for Review'] || 0}</h3>
                        <p style="margin: 5px 0;">Ready for Review</p>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #dbeafe; border-radius: 8px;">
                        <h3 style="color: #1e40af; font-size: 2em; margin: 0;">${byStatus['In Progress'] || 0}</h3>
                        <p style="margin: 5px 0;">In Progress</p>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #d1fae5; border-radius: 8px;">
                        <h3 style="color: #065f46; font-size: 2em; margin: 0;">${byStatus['Approved'] || 0}</h3>
                        <p style="margin: 5px 0;">Approved</p>
                    </div>
                </div>
            `;
        }
        
        function populateRequirementSelect() {
            const select = document.getElementById('requirementSelect');
            select.innerHTML = '<option value="">Select a requirement</option>' +
                currentRequirements.map(req => `<option value="${req.id}">${req.id} - ${req.user_story.substring(0, 50)}...</option>`).join('');
        }
        
        async function generateCommunication() {
            const reqId = document.getElementById('requirementSelect').value;
            const stakeholderType = document.getElementById('stakeholderType').value;
            
            if (!reqId) {
                alert('Please select a requirement');
                return;
            }
            
            try {
                const response = await fetch('/generate_communication', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement_id: reqId,
                        stakeholder_type: stakeholderType
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('communicationTemplate').innerHTML = 
                        `<div class="communication-template">${data.template}</div>`;
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate template'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function updateStatus(reqId) {
            const req = currentRequirements.find(r => r.id === reqId);
            if (req) {
                // Create a modal for status update
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                `;
                
                modalContent.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #667eea;">Update Requirement Status</h3>
                    <p style="margin-bottom: 15px;"><strong>Requirement:</strong> ${req.id}</p>
                    <p style="margin-bottom: 20px; color: #6b7280;">${req.user_story}</p>
                    <p style="margin-bottom: 10px;"><strong>Current Status:</strong> <span class="req-status status-${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span></p>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select New Status:</label>
                        <select id="newStatus" style="width: 100%; padding: 10px; margin-bottom: 15px;">
                            ${getAvailableStatuses(req.status).map(status => 
                                `<option value="${status}" ${status === req.status ? 'selected disabled' : ''}>${status}</option>`
                            ).join('')}
                        </select>
                        
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Add Comment (Optional):</label>
                        <textarea id="statusComment" style="width: 100%; padding: 10px; min-height: 80px;" 
                            placeholder="Add any notes about this status change..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="closeModal()" class="btn-secondary">Cancel</button>
                        <button onclick="confirmStatusUpdate('${reqId}')">Update Status</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Store modal reference for closing
                window.currentModal = modal;
            }
        }
        
        function getAvailableStatuses(currentStatus) {
            // Define workflow rules
            const statusWorkflow = {
                'Draft': ['Draft', 'Ready for Review', 'In Progress', 'Cancelled'],
                'Ready for Review': ['In Progress', 'Approved', 'Draft', 'On Hold'],
                'In Progress': ['In Progress', 'Ready for Testing', 'On Hold', 'Cancelled'],
                'Ready for Testing': ['Testing', 'In Progress', 'On Hold'],
                'Testing': ['Approved', 'In Progress', 'Failed Testing'],
                'Failed Testing': ['In Progress', 'Cancelled'],
                'Approved': ['Approved', 'Deployed', 'In Progress'],
                'Deployed': ['Deployed', 'Closed'],
                'On Hold': ['In Progress', 'Draft', 'Cancelled'],
                'Cancelled': ['Draft'],
                'Closed': ['Closed']
            };
            
            return statusWorkflow[currentStatus] || ['Draft'];
        }
        
        function confirmStatusUpdate(reqId) {
            const req = currentRequirements.find(r => r.id === reqId);
            const newStatus = document.getElementById('newStatus').value;
            const comment = document.getElementById('statusComment').value;
            
            if (req && newStatus && newStatus !== req.status) {
                // Log the change
                const changeLog = {
                    timestamp: new Date().toISOString(),
                    fromStatus: req.status,
                    toStatus: newStatus,
                    comment: comment,
                    requirementId: reqId
                };
                
                // Update the status
                req.status = newStatus;
                req.lastUpdated = new Date().toISOString();
                
                // Add to history (in real app, this would be sent to backend)
                if (!req.history) req.history = [];
                req.history.push(changeLog);
                
                // Refresh displays
                displayRequirements(currentRequirements);
                updateDashboard();
                
                // Show success message
                showNotification(`Status updated to "${newStatus}" successfully!`);
            }
            
            closeModal();
        }
        
        function closeModal() {
            if (window.currentModal) {
                window.currentModal.remove();
                window.currentModal = null;
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function editRequirement(reqId) {
            const req = currentRequirements.find(r => r.id === reqId);
            if (req) {
                const newStory = prompt('Edit user story:', req.user_story);
                if (newStory && newStory !== req.user_story) {
                    // In a real app, this would update via API
                    req.user_story = newStory;
                    displayRequirements(currentRequirements);
                }
            }
        }
        
        // BRD Generation Functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.req-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateBRDSelection();
        }
        
        function updateBRDSelection() {
            const selected = document.querySelectorAll('.req-checkbox:checked').length;
            const total = document.querySelectorAll('.req-checkbox').length;
            
            // Update visual feedback
            document.querySelectorAll('.requirement-item').forEach(item => {
                const checkbox = item.querySelector('.req-checkbox');
                if (checkbox && checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Update select all checkbox state
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.checked = selected === total && total > 0;
                selectAll.indeterminate = selected > 0 && selected < total;
            }
        }
        
        async function handleImageUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        data: e.target.result
                    };
                    uploadedImages.push(imageData);
                    displayUploadedImages();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function displayUploadedImages() {
            const container = document.getElementById('uploadedImages');
            container.innerHTML = uploadedImages.map(img => `
                <div class="uploaded-image">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="remove-image" onclick="removeImage(${img.id})">√ó</button>
                </div>
            `).join('');
        }
        
        function removeImage(imageId) {
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            displayUploadedImages();
        }
        
        async function generateBRD() {
            // Get selected requirements
            const selectedReqIds = Array.from(document.querySelectorAll('.req-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedReqIds.length === 0) {
                alert('Please select at least one requirement for the BRD.');
                return;
            }
            
            // Gather project info
            const projectInfo = {
                project_name: document.getElementById('projectName').value || 'Untitled Project',
                author: document.getElementById('authorName').value || 'Business Analyst',
                executive_summary: document.getElementById('executiveSummary').value || 'This document outlines the business requirements for the project.',
                business_objectives: document.getElementById('businessObjectives').value || '- Improve operational efficiency\n- Enhance user experience',
                process_flows: currentDiagrams.length > 0 ? 'See diagrams section' : '[Process flow diagrams to be added]'
            };
            
            try {
                const response = await fetch('/generate_brd', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement_ids: selectedReqIds,
                        project_info: projectInfo,
                        include_diagrams: uploadedImages.length > 0 || currentDiagrams.length > 0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show preview
                    document.getElementById('brdPreview').innerHTML = `
                        <h3>BRD Generated Successfully!</h3>
                        <div class="brd-preview">${data.content_preview}</div>
                        <div style="margin-top: 20px;">
                            <a href="${data.download_url}" download>
                                <button class="btn-success">üì• Download BRD</button>
                            </a>
                        </div>
                    `;
                    
                    showNotification('BRD generated successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate BRD'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Diagram Functions
        function insertDiagramTemplate() {
            const type = document.getElementById('diagramType').value;
            const templates = {
                flowchart: `graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process 1]
    B -->|No| D[Process 2]
    C --> E[End]
    D --> E`,
                sequence: `sequenceDiagram
    participant User
    participant System
    participant Database
    
    User->>System: Login Request
    System->>Database: Validate Credentials
    Database-->>System: Return Result
    System-->>User: Login Response`,
                entityRelationship: `erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER {
        string name
        string email
        string phone
    }
    ORDER {
        int orderNumber
        date orderDate
    }`,
                userJourney: `journey
    title User Journey for New Feature
    section Discovery
      Visit Website: 5: User
      Search Feature: 3: User
    section Registration
      Create Account: 4: User
      Verify Email: 2: User
    section Usage
      Use Feature: 5: User
      Share Experience: 4: User`
            };
            
            if (templates[type]) {
                document.getElementById('diagramCode').value = templates[type];
                renderDiagram();
            }
        }
        
        function renderDiagram() {
            const code = document.getElementById('diagramCode').value;
            const preview = document.getElementById('diagramPreview');
            
            if (!code.trim()) {
                preview.innerHTML = '<p style="color: #9ca3af; text-align: center;">Enter diagram code to see preview</p>';
                return;
            }
            
            try {
                preview.innerHTML = `<div class="mermaid">${code}</div>`;
                mermaid.init(undefined, preview.querySelector('.mermaid'));
                
                // Save diagram
                currentDiagrams.push({
                    id: Date.now(),
                    code: code,
                    type: document.getElementById('diagramType').value || 'custom'
                });
                
                showNotification('Diagram rendered successfully!');
            } catch (error) {
                preview.innerHTML = `<p style="color: #ef4444;">Error rendering diagram: ${error.message}</p>`;
            }
        }
        
        // Add sample transcript when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('transcriptInput').value = `Meeting: E-commerce Platform Enhancement
Date: January 15, 2024
Attendees: Lisa Chen (Product Owner), Robert Smith (Tech Lead), Amanda Jones (Business Analyst), David Park (UX Designer)

Lisa: Good morning everyone. We need to discuss the new features for our e-commerce platform based on customer feedback.

Robert: I've reviewed the feedback. The main request is that users need to be able to save items to multiple wishlists. The system should allow creating custom wishlist names like "Birthday Gifts" or "Holiday Shopping."

Amanda: Absolutely. We also need to implement a price drop notification feature. Customers want to track price changes on their wishlist items. The system must send email alerts when prices drop by at least 10%.

David: From a UX perspective, users should be able to share their wishlists with friends and family. We need to generate unique shareable links that don't require login to view.

Lisa: Great point. The system should also provide product recommendations based on wishlist items. We want to increase cross-selling opportunities.

Robert: Security-wise, admin users must be able to monitor and moderate shared wishlists for inappropriate content. We need a reporting mechanism.

Amanda: Don't forget about the analytics dashboard. Marketing team needs to track wishlist conversion rates and popular items across all wishlists.

David: One more thing - mobile users should be able to add items to wishlists using barcode scanning. The system must integrate with device cameras.

Lisa: Excellent. We also need to implement wishlist item availability alerts. Users should get notified when out-of-stock items become available again.`;
        });
    </script>
</body>
</html>